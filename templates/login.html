{% extends "base.html" %}

{% block title %}เข้าสู่ระบบ - Trash For Coin | ระบบมัดจำบรรจุภัณฑ์ขยะเพื่อสิ่งแวดล้อมที่ยั่งยืน{% endblock %}

{% block content %}
<!-- Enhanced Login Section -->
<section class="login-section py-5 position-relative overflow-hidden">
    <!-- Background Elements -->
    <div class="login-background position-absolute w-100 h-100" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); opacity: 0.8;"></div>
  <div class="login-pattern position-absolute w-100 h-100" style="background-image: url('data:image/svg+xml,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 viewBox%3D%220 0 100 100%22%3E%3Cdefs%3E%3Cpattern id%3D%22grid%22 width%3D%2220%22 height%3D%2220%22 patternUnits%3D%22userSpaceOnUse%22%3E%3Cpath d%3D%22M 20 0 L 0 0 0 20%22 fill%3D%22none%22 stroke%3D%22rgba(5%2C150%2C105%2C0.05)%22 stroke-width%3D%221%22%2F%3E%3C%2Fpattern%3E%3C%2Fdefs%3E%3Crect width%3D%22100%22 height%3D%22100%22 fill%3D%22url(%23grid)%22%2F%3E%3C%2Fsvg%3E');"></div>
  
    <div class="container position-relative">
        <div class="row justify-content-center align-items-center min-vh-100 py-5">
            <div class="col-lg-5 col-md-7 col-sm-9">
                <div class="login-card card shadow-xl border-0">
                    <!-- Card Header -->
                    <div class="card-header bg-gradient text-white text-center border-0 p-5" 
                         style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                        <div class="login-icon bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center mb-4" 
                             style="width: 100px; height: 100px;">
                            <i class="bi bi-box-arrow-in-right text-white" style="font-size: 3rem;"></i>
                        </div>
                        <h2 class="fw-bold mb-2">ยินดีต้อนรับกลับ</h2>
                        <p class="mb-0 text-white-50">เข้าสู่ระบบ Trash For Coin</p>
                    </div>

                    <!-- Card Body -->
                    <div class="card-body p-5">
                        <!-- Flash Messages -->
                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                <i class="bi bi-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="ปิด"></button>
                            </div>
                            {% endfor %}
                        {% endif %}
                        {% endwith %}

                        <!-- Login Form -->
                        <form method="POST" class="needs-validation login-form" novalidate>
                            <div class="mb-4">
                                <label for="email" class="form-label fw-semibold">อีเมล</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0">
                                        <i class="bi bi-envelope text-muted"></i>
                                    </span>
                                    <input type="email" class="form-control border-start-0 ps-0" id="email" name="email" 
                                           placeholder="กรอกอีเมลของคุณ" required autocomplete="email">
                                    <div class="invalid-feedback">
                                        กรุณากรอกอีเมลที่ถูกต้อง
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="password" class="form-label fw-semibold">รหัสผ่าน</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0">
                                        <i class="bi bi-lock text-muted"></i>
                                    </span>
                                    <input type="password" class="form-control border-start-0 border-end-0 ps-0" id="password" name="password" 
                                           placeholder="กรอกรหัสผ่าน" required autocomplete="current-password">
                                    <button class="btn btn-outline-secondary border-start-0" type="button" id="togglePassword">
                                        <i class="bi bi-eye" id="togglePasswordIcon"></i>
                                    </button>
                                    <div class="invalid-feedback">
                                        กรุณากรอกรหัสผ่าน
                                    </div>
                                </div>
                            </div>

                            <!-- Remember Me & Forgot Password -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="rememberMe" name="remember_me">
                                    <label class="form-check-label text-muted" for="rememberMe">
                                        จดจำการเข้าสู่ระบบ
                                    </label>
                                </div>
                                <a href="#" class="text-primary text-decoration-none small" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">
                                    ลืมรหัสผ่าน?
                                </a>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid mb-4">
                                <button type="submit" class="btn btn-primary btn-lg py-3" id="loginBtn">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>เข้าสู่ระบบ
                                </button>
                            </div>
                        </form>

                        <!-- Divider -->
                        <div class="divider d-flex align-items-center my-4">
                            <div class="flex-grow-1 border-top"></div>
                            <span class="px-3 text-muted small">หรือ</span>
                            <div class="flex-grow-1 border-top"></div>
                        </div>

                        <!-- Register Link -->
                        <div class="text-center">
                            <p class="text-muted mb-3">ยังไม่มีบัญชี?</p>
                            <a href="{{ url_for('register') }}" class="btn btn-outline-primary btn-lg w-100">
                                <i class="bi bi-person-plus me-2"></i>สมัครสมาชิกฟรี
                            </a>
                        </div>

                        <!-- Additional Links -->
                        <div class="text-center mt-4">
                            <div class="d-flex justify-content-center gap-3">
                                <a href="{{ url_for('about') }}" class="text-muted text-decoration-none small">
                                    <i class="bi bi-info-circle me-1"></i>เกี่ยวกับเรา
                                </a>
                                <a href="{{ url_for('contact') }}" class="text-muted text-decoration-none small">
                                    <i class="bi bi-envelope me-1"></i>ติดต่อเรา
                                </a>
                                <a href="#" class="text-muted text-decoration-none small">
                                    <i class="bi bi-shield-check me-1"></i>ความปลอดภัย
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Notice -->
                <div class="security-notice card border-0 shadow-sm mt-4">
                    <div class="card-body p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="bi bi-shield-check text-success me-2 fs-5"></i>
                            <h6 class="fw-bold mb-0">ความปลอดภัยระดับสูง</h6>
                        </div>
                        <p class="text-muted small mb-0">
                            ข้อมูลของคุณได้รับการป้องกันด้วยเทคโนโลยีการเข้ารหัสระดับธนาคาร
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Forgot Password Modal -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                <h5 class="modal-title fw-bold" id="forgotPasswordModalLabel">
                    <i class="bi bi-key me-2"></i>รีเซ็ตรหัสผ่าน
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ปิด"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="forgot-icon bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-envelope text-primary fs-1"></i>
                    </div>
                    <h6 class="fw-bold mb-2">ลืมรหัสผ่าน?</h6>
                    <p class="text-muted small">
                        กรอกอีเมลของคุณ เราจะส่งลิงก์สำหรับรีเซ็ตรหัสผ่านให้คุณ
                    </p>
                </div>
                
                <form class="needs-validation" novalidate>
                    <div class="mb-4">
                        <label for="resetEmail" class="form-label fw-semibold">อีเมล</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-envelope"></i>
                            </span>
                            <input type="email" class="form-control" id="resetEmail" placeholder="กรอกอีเมลของคุณ" required>
                            <div class="invalid-feedback">
                                กรุณากรอกอีเมลที่ถูกต้อง
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send me-2"></i>ส่งลิงก์รีเซ็ต
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            ยกเลิก
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced CSS -->
<style>
    .login-section {
        min-height: 100vh;
        display: flex;
        align-items: center;
    }
    
    .login-card {
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
    }
    
    .login-card:hover {
        transform: translateY(-5px);
        transition: all 0.3s ease;
    }
    
    .login-form .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
    
    .input-group .form-control:focus {
        z-index: 3;
    }
    
    .security-notice:hover {
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }
    
    .login-icon {
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    .divider {
        position: relative;
    }
    
    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--gray-300), transparent);
    }
    
    .btn-primary {
        position: relative;
        overflow: hidden;
    }
    
    .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn-primary:hover::before {
        left: 100%;
    }
    
    .forgot-icon {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Enhanced form validation
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            const forms = document.getElementsByClassName('needs-validation');
            Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    } else {
                        // Show loading state for login form
                        if (form.classList.contains('login-form')) {
                            const loginBtn = document.getElementById('loginBtn');
                            const originalText = loginBtn.innerHTML;
                            loginBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>กำลังเข้าสู่ระบบ...';
                            loginBtn.disabled = true;
                            
                            // Re-enable button after 3 seconds if form submission fails
                            setTimeout(() => {
                                loginBtn.innerHTML = originalText;
                                loginBtn.disabled = false;
                            }, 3000);
                        }
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
    
    // Password toggle functionality
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordField = document.getElementById('password');
        const toggleIcon = document.getElementById('togglePasswordIcon');
        
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            toggleIcon.className = 'bi bi-eye-slash';
        } else {
            passwordField.type = 'password';
            toggleIcon.className = 'bi bi-eye';
        }
    });
    
    // Enhanced email validation
    document.getElementById('email').addEventListener('input', function() {
        const email = this.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email && !emailRegex.test(email)) {
            this.setCustomValidity('กรุณากรอกอีเมลที่ถูกต้อง');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Auto-focus on email field
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('email').focus();
    });
    
    // Remember me functionality
    document.getElementById('rememberMe').addEventListener('change', function() {
        if (this.checked) {
            localStorage.setItem('rememberLogin', 'true');
        } else {
            localStorage.removeItem('rememberLogin');
        }
    });
    
    // Check if remember me was previously set
    if (localStorage.getItem('rememberLogin') === 'true') {
        document.getElementById('rememberMe').checked = true;
    }
    
    // Forgot password form handling
    document.querySelector('#forgotPasswordModal form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('resetEmail').value;
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>กำลังส่ง...';
        submitBtn.disabled = true;
        
        // Simulate API call
        setTimeout(() => {
            // Show success message
            const modalBody = document.querySelector('#forgotPasswordModal .modal-body');
            modalBody.innerHTML = `
                <div class="text-center">
                    <div class="success-icon bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-check-circle text-success fs-1"></i>
                    </div>
                    <h6 class="fw-bold mb-2">ส่งลิงก์เรียบร้อย!</h6>
                    <p class="text-muted small mb-4">
                        เราได้ส่งลิงก์สำหรับรีเซ็ตรหัสผ่านไปยัง<br>
                        <strong>${email}</strong>
                    </p>
                    <p class="text-muted small">
                        กรุณาตรวจสอบอีเมลของคุณ (รวมถึงโฟลเดอร์ Spam)
                    </p>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        เข้าใจแล้ว
                    </button>
                </div>
            `;
        }, 2000);
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Alt + L for login focus
        if (e.altKey && e.key === 'l') {
            e.preventDefault();
            document.getElementById('email').focus();
        }
        
        // Escape to close modals
        if (e.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            });
        }
    });
    
    // Enhanced security check
    function checkPasswordStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        return strength;
    }
    
    // Show password strength indicator (optional)
    document.getElementById('password').addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);
        
        // You could add a visual indicator here
        console.log('Password strength:', strength);
    });
    
    // Prevent form submission on Enter in forgot password modal
    document.getElementById('resetEmail').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.querySelector('#forgotPasswordModal form').dispatchEvent(new Event('submit'));
        }
    });
</script>
{% endblock %}