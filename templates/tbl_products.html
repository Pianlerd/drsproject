{% extends "base.html" %}

{% block title %}จัดการสินค้า - Trash For Coin{% endblock %}

{% block content %}
<section class="btn-primary text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-4">จัดการสินค้า</h1>
                <p class="lead mb-4">จัดการสินค้าและบรรจุภัณฑ์ในระบบ Trash For Coin</p>
            </div>
            <div class="col-lg-4">
                <div class="text-end">
                    {% if session.loggedin and (session.role == 'root_admin' or session.role == 'administrator' or session.role == 'moderator') %}
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#addProductModal">
                            <i class="bi bi-plus-circle me-2"></i>เพิ่มสินค้า
                        </button>
                        <a href="{{ url_for('export_products_csv') }}" class="btn btn-outline-light">
                            <i class="bi bi-download me-2"></i>CSV
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-4 bg-light">
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <form method="POST" class="row g-3">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" name="search" class="form-control" placeholder="ค้นหาชื่อสินค้า, รหัสสินค้า หรือหมวดหมู่" value="{{ search }}">
                </div>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-2"></i>ค้นหา
                </button>
            </div>
            <div class="col-md-2">
                <a href="{{ url_for('tbl_products') }}" class="btn btn-secondary w-100">
                    <i class="bi bi-x-circle me-2"></i>ล้าง
                </a>
            </div>
        </form>

        <h2 class="h4 mt-4 mb-3">รายการสินค้า</h2>
        <div class="table-responsive">
            <table class="table table-hover table-striped border shadow-sm rounded-3 overflow-hidden">
                <thead class="bg-primary text-white">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">รหัสสินค้า</th>
                        <th scope="col">ชื่อสินค้า</th>
                        <th scope="col">สต็อก</th>
                        <th scope="col">ราคา (บาท)</th>
                        <th scope="col">หมวดหมู่</th>
                        <th scope="col">คำอธิบาย</th>
                        <th scope="col">ร้านค้า</th> {# Added Store Column #}
                        <th scope="col">จัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr 
                        data-id="{{ product.id }}" 
                        data-products-id="{{ product.products_id }}" 
                        data-product-name="{{ product.products_name }}"
                        data-stock="{{ product.stock }}"
                        data-price="{{ product.price }}"
                        data-category-id="{{ product.category_id }}"
                        data-description="{{ product.description }}"
                        data-store-id="{{ product.store_id }}" {# Added store_id to data attributes #}
                    >
                        <th scope="row">{{ loop.index }}</th>
                        <td>{{ product.products_id }}</td>
                        <td>{{ product.products_name }}</td>
                        <td>{{ product.stock }}</td>
                        <td>{{ "%.2f"|format(product.price) }}</td>
                        <td>{{ product.category_name or 'N/A' }}</td>
                        <td>{{ product.description }}</td>
                        <td>{{ product.store_name or 'N/A' }}</td> {# Display store name, N/A if None #}
                        <td>
                            <div class="d-flex gap-2">
                                {% if session.loggedin and (session.role == 'root_admin' or session.role == 'administrator' or session.role == 'moderator') %}
                                <button type="button" class="btn btn-warning btn-sm" onclick="editProduct(this)">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteProduct('{{ product.id }}', '{{ product.products_name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-4">ไม่พบข้อมูลสินค้า</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addProductModalLabel">เพิ่มสินค้าใหม่</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('tbl_products') }}" class="needs-validation" novalidate>
                <input type="hidden" name="action" value="add">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_products_id" class="form-label">รหัสสินค้า</label>
                        <input type="text" class="form-control" id="add_products_id" name="products_id" required pattern="[0-9]+" title="กรุณากรอกเฉพาะตัวเลข">
                        <div class="invalid-feedback">กรุณากรอกรหัสสินค้า (ตัวเลขเท่านั้น).</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_product_name" class="form-label">ชื่อสินค้า</label>
                        <input type="text" class="form-control" id="add_product_name" name="product_name" required>
                        <div class="invalid-feedback">กรุณากรอกชื่อสินค้า.</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_stock" class="form-label">สต็อก</label>
                        <input type="number" class="form-control" id="add_stock" name="stock" min="0" value="0" required>
                        <div class="invalid-feedback">กรุณากรอกสต็อกสินค้า (ตัวเลขไม่น้อยกว่า 0).</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_price" class="form-label">ราคา (บาท)</label>
                        <input type="number" step="0.01" class="form-control" id="add_price" name="price" min="0" value="0.00" required>
                        <div class="invalid-feedback">กรุณากรอกราคา (ตัวเลขไม่น้อยกว่า 0, ทศนิยม 2 ตำแหน่ง).</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_category_id" class="form-label">หมวดหมู่</label>
                        <select class="form-select" id="add_category_id" name="category_id" required>
                            <option value="">เลือกหมวดหมู่...</option>
                            {% for category in categories %}
                            <option value="{{ category.category_id }}">{{ category.category_id }} - {{ category.category_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">กรุณาเลือกหมวดหมู่.</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_description" class="form-label">คำอธิบาย</label>
                        <textarea class="form-control" id="add_description" name="description" rows="3"></textarea>
                        <div class="invalid-feedback">กรุณากรอกคำอธิบาย.</div>
                    </div>
                    
                    {% if session.role == 'root_admin' or session.role == 'administrator' %}
                    <div class="mb-3">
                        <label for="add_store_id" class="form-label">ร้านค้า</label>
                        <select class="form-select" id="add_store_id" name="store_id" required>
                            <option value="">เลือกร้านค้า...</option>
                            {% for store in stores %}
                            <option value="{{ store.store_id }}">{{ store.store_name }} (ID: {{ store.store_id }})</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">กรุณาเลือกร้านค้า.</div>
                    </div>
                    {% else %}
                    <input type="hidden" name="store_id" value="{{ session.store_id }}">
                    <div class="mb-3">
                        <label class="form-label">ร้านค้า</label>
                        <input type="text" class="form-control" value="{{ session.store_name or 'ไม่มีร้านค้า' }} (ID: {{ session.store_id or 'N/A' }})" readonly>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-success">เพิ่มสินค้า</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="editProductModalLabel">แก้ไขสินค้า</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('tbl_products') }}" class="needs-validation" novalidate>
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="product_db_id" id="edit_product_id"> {# This is the database primary key 'id' #}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_products_id" class="form-label">รหัสสินค้า</label>
                        <input type="text" class="form-control" id="edit_products_id" name="products_id" required pattern="[0-9]+" title="กรุณากรอกเฉพาะตัวเลข">
                        <div class="invalid-feedback">กรุณากรอกรหัสสินค้า (ตัวเลขเท่านั้น).</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_product_name" class="form-label">ชื่อสินค้า</label>
                        <input type="text" class="form-control" id="edit_product_name" name="product_name" required>
                        <div class="invalid-feedback">กรุณากรอกชื่อสินค้า.</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_stock" class="form-label">สต็อก</label>
                        <input type="number" class="form-control" id="edit_stock" name="stock" min="0" required>
                        <div class="invalid-feedback">กรุณากรอกสต็อกสินค้า (ตัวเลขไม่น้อยกว่า 0).</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_price" class="form-label">ราคา (บาท)</label>
                        <input type="number" step="0.01" class="form-control" id="edit_price" name="price" min="0" required>
                        <div class="invalid-feedback">กรุณากรอกราคา (ตัวเลขไม่น้อยกว่า 0, ทศนิยม 2 ตำแหน่ง).</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_category_id" class="form-label">หมวดหมู่</label>
                        <select class="form-select" id="edit_category_id" name="category_id" required>
                            <option value="">เลือกหมวดหมู่...</option>
                            {% for category in categories %}
                            <option value="{{ category.category_id }}">{{ category.category_id }} - {{ category.category_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">กรุณาเลือกหมวดหมู่.</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">คำอธิบาย</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                        <div class="invalid-feedback">กรุณากรอกคำอธิบาย.</div>
                    </div>
                    
                    {% if session.role == 'root_admin' or session.role == 'administrator' %}
                    <div class="mb-3">
                        <label for="edit_store_id" class="form-label">ร้านค้า</label>
                        <select class="form-select" id="edit_store_id" name="store_id" required>
                            <option value="">เลือกร้านค้า...</option>
                            {% for store in stores %}
                            <option value="{{ store.store_id }}">{{ store.store_name }} (ID: {{ store.store_id }})</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">กรุณาเลือกร้านค้า.</div>
                    </div>
                    {% else %}
                    <input type="hidden" name="store_id" id="edit_store_id_hidden">
                    <div class="mb-3">
                        <label class="form-label">ร้านค้า</label>
                        <input type="text" class="form-control" id="edit_store_name_display" value="" readonly>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-warning">บันทึกการแก้ไข</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteForm" method="POST" style="display: none;">
    <input type="hidden" name="action" value="delete">
    <input type="hidden" name="product_db_id" id="delete_product_id"> {# id here is the database primary key #}
</form>

{# Custom Confirmation Modal HTML #}
<div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="customConfirmModalLabel"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="customConfirmModalBody">
                {# Message will be inserted here by JavaScript #}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-danger" id="customConfirmButton">ยืนยัน</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Custom Confirmation Modal function (re-added for use here)
    function customConfirm(title, message, callback) {
        var confirmModal = new bootstrap.Modal(document.getElementById('customConfirmModal'));
        document.getElementById('customConfirmModalLabel').textContent = title;
        document.getElementById('customConfirmModalBody').textContent = message;
        
        var confirmButton = document.getElementById('customConfirmButton');
        confirmButton.onclick = function() {
            callback();
            confirmModal.hide();
        };
        confirmModal.show();
    }


    (function () {
        'use strict';
        window.addEventListener('load', function () {
            var forms = document.getElementsByTagName('form');
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Function to populate and show the edit product modal
    function editProduct(element) {
        var row = element.closest('tr'); // Get the closest table row
        var id = row.dataset.id; // Database primary key
        var products_id = row.dataset.productsId;
        var product_name = row.dataset.productName;
        var stock = row.dataset.stock;
        var price = row.dataset.price;
        var category_id = row.dataset.categoryId;
        var description = row.dataset.description;
        // ลบ: var barcode_id = row.dataset.barcodeId;
        var store_id = row.dataset.storeId;

        document.getElementById('edit_product_id').value = id;
        document.getElementById('edit_products_id').value = products_id;
        document.getElementById('edit_product_name').value = product_name;
        document.getElementById('edit_stock').value = stock;
        document.getElementById('edit_price').value = price;
        document.getElementById('edit_category_id').value = category_id;
        document.getElementById('edit_description').value = description;
        // ลบ: document.getElementById('edit_barcode_id').value = barcode_id;
        
        // Set store_id for the dropdown or hidden input
        // Check if the element edit_store_id exists before trying to set its value
        var editStoreIdElement = document.getElementById('edit_store_id');
        if (editStoreIdElement) {
            editStoreIdElement.value = store_id;
        }
        // For moderator, the hidden input 'edit_store_id_hidden' receives its value directly from Flask's rendering,
        // so no JS update is needed for it.
        var editStoreIdHidden = document.getElementById('edit_store_id_hidden');
        if (editStoreIdHidden) {
            editStoreIdHidden.value = store_id; // Set the hidden input value from data attributes
        }
        var editStoreNameDisplay = document.getElementById('edit_store_name_display');
        if (editStoreNameDisplay) {
            // Use the store_name from the current session or a default for display
            editStoreNameDisplay.value = "{{ session.store_name or 'ไม่มีร้านค้า' }} (ID: {{ session.store_id or 'N/A' }})";
        }


        var editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
        editModal.show();
    }

    function deleteProduct(id, name) {
        customConfirm('ยืนยันการลบ', 'ต้องการลบสินค้า ' + name + ' หรือไม่?', function() {
            document.getElementById('delete_product_id').value = id; // id here is the database primary key
            document.getElementById('deleteForm').submit();
        });
    }
</script>
{% endblock %}