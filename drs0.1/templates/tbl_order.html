{% extends "base.html" %}

{% block title %}จัดการคำสั่งซื้อ - Trash For Coin{% endblock %}

{% block content %}
<section class="btn-primary text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-4">ตารางเก็บข้อมูลคำสั่งซื้อ</h1>
                <p class="lead mb-4">จัดการคำสั่งซื้อทั้งหมดในระบบ</p>
            </div>
            <div class="col-lg-4">
                <div class="text-end">
                    {# เพิ่ม 'viewer' ในเงื่อนไขการแสดงปุ่ม #}
                    {% if session.loggedin and (session.role == 'root_admin' or session.role == 'administrator' or session.role == 'moderator' or session.role == 'member' or session.role == 'viewer') %}
                    <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                        <i class="bi bi-plus-circle me-2"></i>เพิ่มคำสั่งซื้อใหม่
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-4 bg-light">
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
                <i class="bi bi-info-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <form method="POST" class="row g-3">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" name="search" class="form-control" placeholder="ค้นหารหัสคำสั่งซื้อ, ชื่อสินค้า, หรืออีเมลลูกค้า" value="{{ search }}">
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-2"></i>ค้นหา
                    </button>
                    <a href="{{ url_for('tbl_order') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise me-2"></i>รีเซ็ต
                    </a>
                </div>
            </div>
        </form>
    </div>
</section>
<section class="py-5">
    <div class="container">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">รายการคำสั่งซื้อ</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>รหัสคำสั่งซื้อ</th>
                                <th>รหัสสินค้า</th>
                                <th>ชื่อสินค้า</th>
                                <th>จำนวน</th>
                                <th>จำนวนทิ้ง</th>
                                <th>ราคาต่อหน่วย</th>
                                <th>ราคารวม</th>
                                <th>อีเมลลูกค้า</th>
                                <th>บาร์โค้ด</th>
                                <th>ร้านค้า</th>
                                <th>วันที่สั่งซื้อ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ order.order_id }}</td>
                                <td>{{ order.products_id }}</td>
                                <td>{{ order.products_name }}</td>
                                <td>{{ order.quantity }}</td>
                                <td>{{ order.disquantity }}</td>
                                <td>{{ "%.2f"|format(order.price) }}</td>
                                <td>{{ "%.2f"|format(order.quantity * order.price) }}</td>
                                <td>{{ order.email }}</td>
                                <td>{{ order.barcode_id if order.barcode_id else '-' }}</td>
                                <td>{{ order.store_name if order.store_name else 'ไม่มีร้านค้า' }}</td>
                                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M:%S') if order.order_date else '-' }}</td>
                                <td>
                                    <button class="btn btn-info btn-sm me-2"
                                        data-id="{{ order.id }}"
                                        data-order_id="{{ order.order_id }}"
                                        data-products_name="{{ order.products_name }}"
                                        data-quantity="{{ order.quantity }}"
                                        data-email="{{ order.email }}"
                                        data-barcode_id="{{ order.barcode_id }}"
                                        data-disquantity="{{ order.disquantity }}"
                                        onclick="viewOrderFromData(this)">
                                        <i class="bi bi-eye"></i> ดู
                                    </button>
                                    <button class="btn btn-warning btn-sm me-2"
                                        data-id="{{ order.id }}"
                                        data-order_id="{{ order.order_id }}"
                                        data-products_id="{{ order.products_id }}"
                                        data-quantity="{{ order.quantity }}"
                                        data-email="{{ order.email }}"
                                        data-barcode_id="{{ order.barcode_id }}"
                                        data-disquantity="{{ order.disquantity }}"
                                        data-store_id="{{ order.store_id }}"
                                        onclick="editOrderFromData(this)">
                                        <i class="bi bi-pencil-square"></i> แก้ไข
                                    </button>
                                    <button class="btn btn-danger btn-sm"
                                        data-id="{{ order.id }}"
                                        data-order_id="{{ order.order_id }}"
                                        data-email="{{ order.email }}"
                                        onclick="deleteOrderFromData(this)">
                                        <i class="bi bi-trash"></i> ลบ
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="13" class="text-center text-muted">ไม่พบข้อมูลคำสั่งซื้อ</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
function viewOrderFromData(btn) {
    viewOrder(
        btn.dataset.id,
        btn.dataset.order_id,
        btn.dataset.products_name,
        btn.dataset.quantity,
        btn.dataset.email,
        btn.dataset.barcode_id,
        btn.dataset.disquantity
    );
}

function editOrderFromData(btn) {
    editOrder(
        btn.dataset.id,
        btn.dataset.order_id,
        btn.dataset.products_id,
        btn.dataset.quantity,
        btn.dataset.email,
        btn.dataset.barcode_id,
        btn.dataset.disquantity,
        btn.dataset.store_id
    );
}

function deleteOrderFromData(btn) {
    deleteOrder(
        btn.dataset.id,
        btn.dataset.order_id,
        btn.dataset.email
    );
}
</script>


{# Add Order Modal #}
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addOrderModalLabel">เพิ่มคำสั่งซื้อใหม่</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" class="needs-validation" novalidate>
                <div class="modal-body">
                    <input type="hidden" name="action" value="add">
                    <div class="mb-3">
                        <label for="order_id" class="form-label">รหัสคำสั่งซื้อ</label>
                        <input type="text" class="form-control" id="order_id" name="order_id" required>
                        <div class="invalid-feedback">กรุณากรอกรหัสคำสั่งซื้อ</div>
                    </div>
                    <div class="mb-3">
                        <label for="products_id" class="form-label">รหัสสินค้า</label>
                        <select class="form-select" id="products_id" name="products_id" required>
                            <option value="">เลือกสินค้า...</option>
                            {% for product in products %}
                                <option value="{{ product.products_id }}" data-stock="{{ product.stock }}" data-price="{{ product.price }}">{{ product.products_name }} ({{ product.products_id }}) - สต็อก: {{ product.stock }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">กรุณาเลือกสินค้า</div>
                        <div class="form-text" id="product_stock_info">สต็อกคงเหลือ: 0 | ราคา: 0.00 บาท</div>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">จำนวน</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" value="1" required min="1">
                        <div class="invalid-feedback">กรุณากรอกจำนวน (ตัวเลขเท่านั้น)</div>
                        <div class="form-text text-danger" id="quantity_error_message" style="display: none;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="disquantity" class="form-label">จำนวนที่ทิ้ง/เสียหาย</label>
                        <input type="number" class="form-control" id="disquantity" name="disquantity" value="0" required min="0">
                        <div class="invalid-feedback">กรุณากรอกจำนวนที่ทิ้ง/เสียหาย (ตัวเลขเท่านั้น)</div>
                        <div class="form-text text-danger" id="disquantity_error_message" style="display: none;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">อีเมลลูกค้า</label>
                        <select class="form-select" id="email" name="email" required>
                            <option value="">เลือกอีเมล...</option>
                            {% for user in users %}
                                <option value="{{ user.email }}">{{ user.fullname }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">กรุณาเลือกอีเมลลูกค้า</div>
                    </div>
                    <div class="mb-3">
                        <label for="barcode_id" class="form-label">รหัสบาร์โค้ด</label>
                        <input type="text" class="form-control" id="barcode_id" name="barcode_id" required pattern="[0-9]{13}" title="กรุณากรอกบาร์โค้ด 13 หลัก">
                        <div class="invalid-feedback">กรุณากรอกรหัสบาร์โค้ด 13 หลัก</div>
                        <div class="form-text">กรุณากรอกรหัสบาร์โค้ด 13 หลักด้วยตนเอง</div>
                    </div>
                    {# Logic สำหรับ Store Selection #}
                    {% if session.role == 'root_admin' or session.role == 'administrator' %}
                    <div class="mb-3">
                        <label for="add_store_id" class="form-label">ร้านค้า</label>
                        <select class="form-select" id="add_store_id" name="store_id">
                            <option value="">ไม่มีร้านค้า (Global)</option>
                            {% for store in stores %}
                                <option value="{{ store.store_id }}">{{ store.store_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            เลือกเพื่อผูกคำสั่งซื้อกับร้านค้าเฉพาะ หากไม่เลือกจะถือเป็นคำสั่งซื้อทั่วไป.
                        </div>
                    </div>
                    {% else %}
                    {# สำหรับ Moderator, Member, Viewer, store_id จะถูกกำหนดโดยอัตโนมัติจาก session #}
                    <input type="hidden" name="store_id" value="{{ session.store_id }}">
                    <div class="mb-3">
                        <label class="form-label">ร้านค้า</label>
                        <input type="text" class="form-control" value="{{ session.store_name if session.store_name else 'ร้านค้าของคุณ' }}" disabled>
                        <div class="form-text">
                            คำสั่งซื้อจะถูกผูกกับร้านค้าของคุณ/จำลองโดยอัตโนมัติ.
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">เพิ่มคำสั่งซื้อ</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# View Order Modal #}
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-labelledby="viewOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="viewOrderModalLabel">รายละเอียดคำสั่งซื้อ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">รหัสคำสั่งซื้อ:</dt>
                    <dd class="col-sm-8" id="view_order_id"></dd>

                    <dt class="col-sm-4">ชื่อสินค้า:</dt>
                    <dd class="col-sm-8" id="view_products_name"></dd>

                    <dt class="col-sm-4">จำนวน:</dt>
                    <dd class="col-sm-8" id="view_quantity"></dd>

                    <dt class="col-sm-4">จำนวนที่ทิ้ง:</dt>
                    <dd class="col-sm-8" id="view_disquantity"></dd>

                    <dt class="col-sm-4">อีเมลลูกค้า:</dt>
                    <dd class="col-sm-8" id="view_email"></dd>

                    <dt class="col-sm-4">บาร์โค้ด:</dt>
                    <dd class="col-sm-8" id="view_barcode_id"></dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

{# Edit Order Modal #}
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editOrderModalLabel">แก้ไขคำสั่งซื้อ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" class="needs-validation" novalidate>
                <div class="modal-body">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" id="edit_ord_id" name="ord_id">
                    <input type="hidden" id="original_products_id" name="original_products_id"> {# Hidden field to store original product_id #}
                    <div class="mb-3">
                        <label for="edit_order_id" class="form-label">รหัสคำสั่งซื้อ</label>
                        <input type="text" class="form-control" id="edit_order_id" name="order_id" required>
                        <div class="invalid-feedback">กรุณากรอกรหัสคำสั่งซื้อ</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_products_id" class="form-label">รหัสสินค้า</label>
                        <select class="form-select" id="edit_products_id" name="products_id" required>
                            <option value="">เลือกสินค้า...</option>
                            {% for product in products %}
                                <option value="{{ product.products_id }}" data-stock="{{ product.stock }}" data-price="{{ product.price }}">{{ product.products_name }} ({{ product.products_id }}) - สต็อก: {{ product.stock }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">กรุณาเลือกสินค้า</div>
                        <div class="form-text" id="edit_product_stock_info">สต็อกคงเหลือ: 0 | ราคา: 0.00 บาท</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_quantity" class="form-label">จำนวน</label>
                        <input type="number" class="form-control" id="edit_quantity" name="quantity" required min="1">
                        <div class="invalid-feedback">กรุณากรอกจำนวน (ตัวเลขเท่านั้น)</div>
                        <div class="form-text text-danger" id="edit_quantity_error_message" style="display: none;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_disquantity" class="form-label">จำนวนที่ทิ้ง/เสียหาย</label>
                        <input type="number" class="form-control" id="edit_disquantity" name="disquantity" value="0" required min="0">
                        <div class="invalid-feedback">กรุณากรอกจำนวนที่ทิ้ง/เสียหาย (ตัวเลขเท่านั้น)</div>
                        <div class="form-text text-danger" id="edit_disquantity_error_message" style="display: none;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">อีเมลลูกค้า</label>
                        <select class="form-select" id="edit_email" name="email" required>
                            <option value="">เลือกอีเมล...</option>
                            {% for user in users %}
                                <option value="{{ user.email }}">{{ user.fullname }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">กรุณาเลือกอีเมลลูกค้า</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_barcode_id" class="form-label">รหัสบาร์โค้ด</label>
                        <input type="text" class="form-control" id="edit_barcode_id" name="barcode_id" required pattern="[0-9]{13}" title="กรุณากรอกบาร์โค้ด 13 หลัก">
                        <div class="invalid-feedback">กรุณากรอกรหัสบาร์โค้ด 13 หลัก</div>
                        <div class="form-text">กรุณากรอกรหัสบาร์โค้ด 13 หลักด้วยตนเอง</div>
                    </div>
                    {# Logic สำหรับ Store Selection #}
                    {% if session.role == 'root_admin' or session.role == 'administrator' %}
                    <div class="mb-3">
                        <label for="edit_store_id" class="form-label">ร้านค้า</label>
                        <select class="form-select" id="edit_store_id" name="store_id">
                            <option value="">ไม่มีร้านค้า (Global)</option>
                            {% for store in stores %}
                                <option value="{{ store.store_id }}">{{ store.store_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            เลือกเพื่อผูกคำสั่งซื้อกับร้านค้าเฉพาะ หากไม่เลือกจะถือเป็นคำสั่งซื้อทั่วไป.
                        </div>
                    </div>
                    {% else %}
                    {# สำหรับ Moderator, Member, Viewer, store_id จะถูกกำหนดโดยอัตโนมัติจาก session #}
                    <input type="hidden" name="store_id" id="edit_store_id_hidden">
                    <div class="mb-3">
                        <label class="form-label">ร้านค้า</label>
                        <input type="text" class="form-control" value="{{ session.store_name if session.store_name else 'ร้านค้าของคุณ' }}" disabled>
                        <div class="form-text">
                            คำสั่งซื้อจะถูกผูกกับร้านค้าของคุณ/จำลองโดยอัตโนมัติ.
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-warning">บันทึกการเปลี่ยนแปลง</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Delete Order Form (Hidden) #}
<form id="deleteForm" method="POST" style="display: none;">
    <input type="hidden" name="action" value="delete">
    <input type="hidden" name="ord_id" id="delete_ord_id">
    <input type="hidden" name="email" id="delete_order_email">
</form>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            var forms = document.getElementsByTagName('form');
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // Product selection change for Add Order Modal
    document.addEventListener('DOMContentLoaded', function() {
        var addProductIdSelect = document.getElementById('products_id');
        var addProductStockInfo = document.getElementById('product_stock_info');
        var addQuantityInput = document.getElementById('quantity');
        var addQuantityErrorMessage = document.getElementById('quantity_error_message');
        var addDisquantityInput = document.getElementById('disquantity');
        var addDisquantityErrorMessage = document.getElementById('disquantity_error_message');
        // Removed addBarcodeIdInput as it's now manually entered

        // Function to validate quantity against stock
        function validateAddQuantityAgainstStock() {
            var selectedOption = addProductIdSelect.options[addProductIdSelect.selectedIndex];
            var stock = parseInt(selectedOption.dataset.stock) || 0;
            var price = parseFloat(selectedOption.dataset.price) || 0.00;

            addProductStockInfo.textContent = `สต็อกคงเหลือ: ${stock} | ราคา: ${price.toFixed(2)} บาท`;

            var quantity = parseInt(addQuantityInput.value) || 0;
            if (quantity > stock) {
                addQuantityInput.classList.add('is-invalid');
                addQuantityErrorMessage.textContent = `จำนวนที่สั่งซื้อ (${quantity}) เกินสต็อกที่มี (${stock}).`;
                addQuantityErrorMessage.style.display = 'block';
            } else {
                addQuantityInput.classList.remove('is-invalid');
                addQuantityErrorMessage.style.display = 'none';
            }

            // Validate disquantity against quantity
            var disquantity = parseInt(addDisquantityInput.value) || 0;
            if (disquantity > quantity) {
                addDisquantityInput.classList.add('is-invalid');
                addDisquantityErrorMessage.textContent = `จำนวนที่ทิ้ง/เสียหาย (${disquantity}) ต้องไม่เกินจำนวนที่สั่งซื้อ (${quantity}).`;
                addDisquantityErrorMessage.style.display = 'block';
            } else {
                addDisquantityInput.classList.remove('is-invalid');
                addDisquantityErrorMessage.style.display = 'none';
            }
        }

        addProductIdSelect.addEventListener('change', validateAddQuantityAgainstStock);
        addQuantityInput.addEventListener('input', validateAddQuantityAgainstStock);
        addDisquantityInput.addEventListener('input', validateAddQuantityAgainstStock);

        // Initial call for product selection change if an option is pre-selected (e.g. after form submission error)
        if (addProductIdSelect.value) {
            validateAddQuantityAgainstStock();
        }
    });

    // Product selection change for Edit Order Modal
    document.addEventListener('DOMContentLoaded', function() {
        var editProductsIdSelect = document.getElementById('edit_products_id');
        var editProductStockInfo = document.getElementById('edit_product_stock_info');
        var editQuantityInput = document.getElementById('edit_quantity');
        var editQuantityErrorMessage = document.getElementById('edit_quantity_error_message');
        var editDisquantityInput = document.getElementById('edit_disquantity');
        var editDisquantityErrorMessage = document.getElementById('edit_disquantity_error_message');
        // Removed editBarcodeIdInput as it's now manually entered
        var originalProductsIdHidden = document.getElementById('original_products_id');


        // Function to validate quantity against stock for Edit Modal
        function validateEditQuantityAgainstStock() {
            var selectedOption = editProductsIdSelect.options[editProductsIdSelect.selectedIndex];
            var stock = parseInt(selectedOption.dataset.stock) || 0;
            var price = parseFloat(selectedOption.dataset.price) || 0.00;

            editProductStockInfo.textContent = `สต็อกคงเหลือ: ${stock} | ราคา: ${price.toFixed(2)} บาท`;

            // Special handling for edit: we need to consider original quantity if product_id is the same
            var currentOrderQuantity = parseInt(editQuantityInput.dataset.currentQuantity) || 0;
            var currentOrderProductId = originalProductsIdHidden.value; // Get original product ID
            
            var quantity = parseInt(editQuantityInput.value) || 0;
            var disquantity = parseInt(editDisquantityInput.value) || 0;

            let effectiveStock = stock;
            if (editProductsIdSelect.value === currentOrderProductId) { // If product is NOT changed
                 effectiveStock = stock + currentOrderQuantity; // Add back original quantity to stock for calculation
            }

            if (quantity > effectiveStock) {
                editQuantityInput.classList.add('is-invalid');
                editQuantityErrorMessage.textContent = `จำนวนที่สั่งซื้อ (${quantity}) เกินสต็อกที่มี (${effectiveStock}).`;
                editQuantityErrorMessage.style.display = 'block';
            } else {
                editQuantityInput.classList.remove('is-invalid');
                editQuantityErrorMessage.style.display = 'none';
            }

            // Validate disquantity against quantity
            if (disquantity > quantity) {
                editDisquantityInput.classList.add('is-invalid');
                editDisquantityErrorMessage.textContent = `จำนวนที่ทิ้ง/เสียหาย (${disquantity}) ต้องไม่เกินจำนวนที่สั่งซื้อ (${quantity}).`;
                editDisquantityErrorMessage.style.display = 'block';
            } else {
                editDisquantityInput.classList.remove('is-invalid');
                editDisquantityErrorMessage.style.display = 'none';
            }
        }

        editProductsIdSelect.addEventListener('change', validateEditQuantityAgainstStock);
        editQuantityInput.addEventListener('input', validateEditQuantityAgainstStock);
        editDisquantityInput.addEventListener('input', validateEditQuantityAgainstStock);
        
        // Initial setup for edit modal
        // No initial call for disquantity validation or barcode update from product select
    });


    function editOrder(id, order_id, products_id, quantity, email, barcode_id, disquantity, store_id) { // เพิ่ม store_id parameter
        document.getElementById('edit_ord_id').value = id;
        document.getElementById('edit_order_id').value = order_id;
        document.getElementById('original_products_id').value = products_id; // Store original product_id

        // Set the selected product in the dropdown
        var productsSelect = document.getElementById('edit_products_id');
        productsSelect.value = products_id;
        // Trigger change event manually to update stock info
        productsSelect.dispatchEvent(new Event('change'));

        document.getElementById('edit_quantity').value = quantity;
        document.getElementById('edit_quantity').dataset.currentQuantity = quantity; // Store current quantity for stock calculation
        document.getElementById('edit_disquantity').value = disquantity;
        
        // Set the selected email in the dropdown
        var emailSelect = document.getElementById('edit_email');
        emailSelect.value = email;
        
        document.getElementById('edit_barcode_id').value = barcode_id; // Set barcode_id to the provided value

        // Logic สำหรับการตั้งค่า store_id ใน Modal แก้ไข
        var sessionRole = "{{ session.role }}";
        if (sessionRole === 'root_admin' || sessionRole === 'administrator') {
            document.getElementById('edit_store_id').value = store_id;
        } else { // Moderator, Member, Viewer
            // ตั้งค่า hidden input และ display field สำหรับ Moderator, Member, Viewer
            var editStoreIdHidden = document.getElementById('edit_store_id_hidden');
            if (editStoreIdHidden) { // เช็คว่า element มีอยู่จริง
                editStoreIdHidden.value = store_id;
            }
            var editStoreNameDisplay = document.getElementById('edit_store_name_display');
            if (editStoreNameDisplay) { // เช็คว่า element มีอยู่จริง
                editStoreNameDisplay.value = "{{ session.store_name if session.store_name else 'ร้านค้าของคุณ' }}";
            }
        }

        var editModal = new bootstrap.Modal(document.getElementById('editOrderModal'));
        editModal.show();
    }

    function viewOrder(id, order_id, products_name, quantity, email, barcode_id, disquantity) {
        document.getElementById('view_order_id').textContent = order_id;
        document.getElementById('view_products_name').textContent = products_name;
        document.getElementById('view_quantity').textContent = quantity;
        document.getElementById('view_disquantity').textContent = disquantity;
        document.getElementById('view_email').textContent = email;
        document.getElementById('view_barcode_id').textContent = barcode_id;

        var viewModal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
        viewModal.show();
    }

    function deleteOrder(id, order_id, email) {
        if (confirm('ต้องการลบคำสั่งซื้อ ' + order_id + ' หรือไม่?')) {
            document.getElementById('delete_ord_id').value = id;
            document.getElementById('delete_order_email').value = email;
            document.getElementById('deleteForm').submit();
        }
    }
</script>
{% endblock %}
